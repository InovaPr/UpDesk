<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Sistema de Acompanhamento de Chamados</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            padding: 20px;
            background-color: #f0f0f0;
        }

        #loginContainer {
            max-width: 300px;
            margin: 50px auto;
            padding: 20px;
            background: white;-
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #mainContainer {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        #slaStatistics {
            display: flex;
            justify-content: space-between;
            background-color: #f4f4f4;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
        }

        #slaStatistics .sla-stats {
            display: flex;
            gap: 20px;
        }

        #slaStatistics .sla-stats div {
            background-color: white;
            padding: 5px 10px;
            border-radius: 3px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        input, select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background-color: #007bff;
        }

        .ticket-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            padding: 15px;
            background-color: #f9f9f9;
            margin-bottom: 10px;
            border-radius: 4px;
            align-items: center;
        }

        .timer {
            font-size: 1.2em;
            font-weight: bold;
        }

        .green { background-color: #90EE90 !important; }
        .yellow { background-color: #FFFF99 !important; }
        .orange { background-color: #FFB366 !important; }
        .red { background-color: #FF9999 !important; }

        #ticketList {
            margin-top: 20px;
        }

        .error-message {
            color: red;
            margin-top: 5px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }

        th {
            background-color: #007bff;
        }
    </style>
</head>
<body>
    <div id="loginContainer">
        <h2>Login</h2>
        <div class="input-group">
            <label for="username">Usuário:</label>
            <input type="text" id="username" required>
        </div>
        <div class="input-group">
            <label for="password">Senha:</label>
            <input type="password" id="password" required>
        </div>
        <button onclick="login()">Entrar</button>
        <p id="loginError" class="error-message"></p>
    </div>

   <div id="mainContainer">
    <h1>Sistema de Acompanhamento de Chamados</h1>
    <button onclick="addNewTicket()">Adicionar Novo Chamado</button>
    <button onclick="showDatabase()">Visualizar Chamados</button>
    <button onclick="showGraphs()">Visualizar Graficos</button>
    <button onclick="logout()">Logout</button> <!-- Add this line -->
    <div id="ticketList"></div>

    <div id="databaseView" style="display: none;">

        <h2>Registros de Chamados</h2>
        <div class="input-group">
            <label>Filtrar por PROBLEMA:</label>
            <input list="problemaOptions" id="filterPR">
            <datalist id="problemaOptions">
                <option value="Acesso Lento"></option>
                <option value="Acréscimo de canais"></option>
                <option value="Adição de equipamento"></option>
                <option value="Ajuste no IPV6"></option>
                <option value="Ativação de Link"></option>
                <option value="Ativação de Telefonia"></option>
                <option value="Cliente entrou em contato pedindo uma informação tecnica"></option>
                <option value="Falha elétrica no cliente"></option>
                <option value="Falha elétrica no POP da Inovanet"></option>
                <option value="Falha no equipamento da Inovanet"></option>
                <option value="Falha no fornecimento de internet pela ALGAR"></option>
                <option value="Falha no fornecimento de internet pela BR DIGITAL"></option>
                <option value="Falha no link de transporte"></option>
                <option value="Help Desk Presencial"></option>
                <option value="Help Desk Remoto"></option>
                <option value="Help Desk Telefonia"></option>
                <option value="Implantar cabo de internet"></option>
                <option value="Mudança de endereço"></option>
                <option value="Mudança de Equipamentos"></option>
                <option value="Mudança de Local do Aparelho"></option>
                <option value="Operadora de telefonia com falha de rotas"></option>
                <option value="Orçamento"></option>
                <option value="Outros"></option>
                <option value="Portabilidade da linha"></option>
                <option value="Problema na Hybrid"></option>
                <option value="Problemas com páginas"></option>
                <option value="Problemas no VOIP"></option>
                <option value="Recolher equipamento"></option>
                <option value="Rompimento do Backbone em Natal"></option>
                <option value="Rompimento do drop do cliente em Ceará-Mirim"></option>
                <option value="Rompimento do drop do cliente em Mossoró"></option>
                <option value="Rompimento do drop do cliente em Natal"></option>
                <option value="Rompimento do drop do cliente em Parnamirim"></option>
                <option value="Rompimento no drop em STO"></option>
                <option value="Rompimento no transporte da Intelnet"></option>
                <option value="Rompimento no transporte para Ceará-Mirim"></option>
                <option value="Rompimento no transporte para São José de Mipibu"></option>
                <option value="Sem Acesso"></option>
                <option value="Sem ping"></option>
                <option value="Solicitação BGP"></option>
                <option value="Solicitação de linha nova"></option>
                <option value="Troca de CEO"></option>
                <option value="Troca de conector tipo click"></option>
                <option value="Troca de conector tipo RJ45"></option>
                <option value="Troca de CTO"></option>
                <option value="Troca de DROP"></option>
                <option value="Troca de fonte com defeito"></option>
                <option value="Troca de splitter"></option>
            </datalist>

            <label>Filtrar por CLIENTE:</label>
            <input list="clienteOptions" id="filterCliente">
            <datalist id="clienteOptions">
                <option value="476"></option>
                <option value="490"></option>
                <option value="135"></option>
                <option value="240"></option>
                <option value="306"></option>
                <option value="317"></option>
                <option value="318"></option>
                <option value="169"></option>
                <option value="110"></option>
                <option value="184"></option>
                <option value="40"></option>
                <option value="65"></option>
                <option value="224"></option>
                <option value="251"></option>
                <option value="370"></option>
                <option value="214"></option>
                <option value="215"></option>
                <option value="342"></option>
                <option value="520"></option>
                <option value="199"></option>
                <option value="467"></option>
                <option value="242"></option>
                <option value="457"></option>
                <option value="22"></option>
                <option value="327"></option>
                <option value="498"></option>
                <option value="500"></option>
                <option value="417"></option>
                <option value="216"></option>
                <option value="248"></option>
                <option value="210"></option>
                <option value="247"></option>
                <option value="80"></option>
                <option value="24"></option>
                <option value="152"></option>
                <option value="51"></option>
                <option value="195"></option>
                <option value="69"></option>
                <option value="205"></option>
                <option value="358"></option>
                <option value="115"></option>
                <option value="119"></option>
                <option value="50"></option>
                <option value="549"></option>
                <option value="550"></option>
                <option value="191"></option>
                <option value="365"></option>
                <option value="13"></option>
                <option value="151"></option>
                <option value="470"></option>
                <option value="405"></option>
                <option value="359"></option>
                <option value="334"></option>
                <option value="404"></option>
                <option value="399"></option>
                <option value="407"></option>
                <option value="55"></option>
                <option value="424"></option>
                <option value="462"></option>
                <option value="469"></option>
                <option value="535"></option>
                <option value="435"></option>
                <option value="222"></option>
                <option value="176"></option>
                <option value="319"></option>
                <option value="570"></option>
                <option value="441"></option>
                <option value="436"></option>
                <option value="437"></option>
                <option value="438"></option>
                <option value="43"></option>
                <option value="446"></option>
                <option value="225"></option>
                <option value="323"></option>
                <option value="15"></option>
                <option value="491"></option>
                <option value="54"></option>
                <option value="109"></option>
                <option value="515"></option>
                <option value="538"></option>
                <option value="539"></option>
                <option value="553"></option>
                <option value="552"></option>
                <option value="21"></option>
                <option value="483"></option>
                <option value="264"></option>
                <option value="37"></option>
                <option value="88"></option>
                <option value="4"></option>
                <option value="245"></option>
                <option value="354"></option>
                <option value="501"></option>
                <option value="447"></option>
                <option value="494"></option>
                <option value="475"></option>
                <option value="418"></option>
                <option value="182"></option>
                <option value="26"></option>
                <option value="512"></option>
                <option value="572"></option>
                <option value="157"></option>
                <option value="187"></option>
                <option value="361"></option>
                <option value="536"></option>
                <option value="243"></option>
                <option value="217"></option>
                <option value="582"></option>
                <option value="579"></option>
                <option value="442"></option>
                <option value="310"></option>
                <option value="198"></option>
                <option value="160"></option>
                <option value="8"></option>
                <option value="161"></option>
                <option value="158"></option>
                <option value="137"></option>
                <option value="165"></option>
                <option value="212"></option>
                <option value="305"></option>
                <option value="140"></option>
                <option value="534"></option>
                <option value="532"></option>
                <option value="132"></option>
                <option value="235"></option>
                <option value="303"></option>
                <option value="433"></option>
                <option value="2"></option>
                <option value="311"></option>
                <option value="285"></option>
                <option value="229"></option>
                <option value="409"></option>
                <option value="465"></option>
                <option value="521"></option>
                <option value="153"></option>
                <option value="527"></option>
                <option value="196"></option>
                <option value="332"></option>
                <option value="5"></option>
                <option value="328"></option>
                <option value="324"></option>
                <option value="408"></option>
                <option value="211"></option>
                <option value="519"></option>
                <option value="422"></option>
                <option value="421"></option>
                <option value="78"></option>
                <option value="471"></option>
                <option value="174"></option>
                <option value="73"></option>
                <option value="67"></option>
                <option value="403"></option>
                <option value="338"></option>
                <option value="102"></option>
                <option value="238"></option>
                <option value="201"></option>
                <option value="396"></option>
                <option value="428"></option>
                <option value="410"></option>
                <option value="406"></option>
                <option value="580"></option>
                <option value="489"></option>
                <option value="518"></option>
                <option value="180"></option>
                <option value="181"></option>
                <option value="260"></option>
                <option value="577"></option>
                <option value="492"></option>
                <option value="559"></option>
                <option value="188"></option>
                <option value="44"></option>
                <option value="297"></option>
                <option value="479"></option>
                <option value="524"></option>
                <option value="148"></option>
                <option value="87"></option>
                <option value="453"></option>
                <option value="108"></option>
                <option value="452"></option>
                <option value="236"></option>
                <option value="444"></option>
                <option value="454"></option>
                <option value="445"></option>
                <option value="448"></option>
                <option value="449"></option>
                <option value="308"></option>
                <option value="309"></option>
                <option value="76"></option>
                <option value="565"></option>
                <option value="466"></option>
                <option value="170"></option>
                <option value="171"></option>
                <option value="360"></option>
                <option value="374"></option>
                <option value="371"></option>
                <option value="555"></option>
                <option value="156"></option>
                <option value="146"></option>
                <option value="484"></option>
                <option value="516"></option>
                <option value="514"></option>
                <option value="197"></option>
                <option value="254"></option>
                <option value="255"></option>
                <option value="413"></option>
                <option value="378"></option>
                <option value="456"></option>
                <option value="507"></option>
                <option value="523"></option>
                <option value="104"></option>
                <option value="185"></option>
                <option value="289"></option>
                <option value="496"></option>
                <option value="463"></option>
                <option value="537"></option>
                <option value="60"></option>
                <option value="18"></option>
                <option value="36"></option>
                <option value="290"></option>
                <option value="316"></option>
                <option value="425"></option>
                <option value="27"></option>
                <option value="257"></option>
                <option value="529"></option>
                <option value="584"></option>
                <option value="574"></option>
                <option value="458"></option>
                <option value="495"></option>
                <option value="48"></option>
                <option value="427"></option>
                <option value="368"></option>
                <option value="213"></option>
                <option value="241"></option>
                <option value="43"></option>
                <option value="517"></option>
                <option value="190"></option>
                <option value="499"></option>
                <option value="522"></option>
                <option value="509"></option>
                <option value="510"></option>
                <option value="511"></option>
                <option value="583"></option>
                <option value="124"></option>
                <option value="431"></option>
                <option value="551"></option>
                <option value="228"></option>
                <option value="322"></option>
                <option value="321"></option>
                <option value="262"></option>
                <option value="394"></option>
                <option value="352"></option>
                <option value="275"></option>
                <option value="315"></option>
                <option value="263"></option>
                <option value="283"></option>
                <option value="280"></option>
                <option value="270"></option>
                <option value="276"></option>
                <option value="295"></option>
                <option value="246"></option>
                <option value="353"></option>
                <option value="302"></option>
                <option value="232"></option>
                <option value="451"></option>
                <option value="506"></option>
                <option value="343"></option>
                <option value="286"></option>
                <option value="325"></option>
                <option value="485"></option>
                <option value="220"></option>
                <option value="189"></option>
                <option value="575"></option>
                <option value="155"></option>
                <option value="573"></option>
                <option value="414"></option>
                <option value="505"></option>
                <option value="143"></option>
                <option value="144"></option>
                <option value="123"></option>
                <option value="330"></option>
                <option value="480"></option>
                <option value="434"></option>
                <option value="96"></option>
                <option value="17"></option>
                <option value="493"></option>
                <option value="531"></option>
                <option value="145"></option>
                <option value="347"></option>
                <option value="557"></option>
                <option value="432"></option>
                <option value="271"></option>
                <option value="416"></option>
                <option value="223"></option>
                <option value="450"></option>
                <option value="369"></option>
                <option value="478"></option>
                <option value="571"></option>
                <option value="576"></option>
                <option value="298"></option>
                <option value="391"></option>
                <option value="388"></option>
                <option value="389"></option>
                <option value="393"></option>
                <option value="390"></option>
                <option value="162"></option>
                <option value="340"></option>
                <option value="204"></option>
            </datalist>

            <label>Filtrar por OPERADOR:</label>
            <input list="operadorOptions" id="filterOperador">
            <datalist id="operadorOptions">
                <option value="Castelo"></option>
                <option value="Marcelo"></option>
                <option value="kaline"></option>
                <option value="Gabriel"></option>
                <option value="Jefferson"></option>
            </datalist>
            
            <label>Filtrar por EXECUTOR:</label>
            <input list="executorOptions" id="filterEX">
            <datalist id="executorOptions">
                <option value="Airton"></option>
                <option value="Damião"></option>
                <option value="Daniel"></option>
                <option value="Alison"></option>

            </datalist>

            <label>Filtrar por STATUS DO PRAZO:</label>
            <input list="statusOptions" id="filterStatus">
            <datalist id="statusOptions">
                <option value="No Prazo"></option>
                <option value="Fora do Prazo"></option>
            </datalist>
    
            <label>Filtrar por INTERVALO DE DATAS:</label>
            <input type="text" id="filterDateRange" placeholder="Selecione o intervalo de datas">
            <button onclick="applyFilters()">Aplicar Filtros</button>
            <button onclick="downloadExcel()">Download Excel</button>
            <button onclick="clearDatabase()">Limpar Banco de Dados</button>

        <table id="databaseTable">
            <thead>
                <tr>
                    <th>TEMPO</th>
                    <th>CLIENTE</th>
                    <th>PROBLEMA</th>
                    <th>OPERADOR</th>
                    <th>EXECUTOR</th>
                    <th>HORA DE ABERTURA</th>
                    <th>ARQUIVADO POR:</th>
                    <th>HORA DE ENCERRAMENTO</th>
                    <th>TEMPO DE EXECUÇÃO</th>
                    <th>STATUS DO PRAZO</th>
                </tr>
            </thead>
            <tbody id="databaseTableBody"></tbody>
        </table>
    </div>
</div>

<div id="graphsView" style="display: none;">
    <div class="container">
        <h2>Gráficos</h2>

        <div class="charts" style="display: flex; justify-content: space-between;">

            <div class="chart-container" style="flex: 1; padding: 10px;">
                <h3>Prazos</h3>
                
                <div class="filters" style="margin-bottom: 10px;">
                    <div class="filter">
                        <label for="customerFilterPie">Clientes:</label>
                        <select id="customerFilterPie">
                            <option value="all">Todos</option>
                            <option value="476"></option>
                            
                        </select>
                    </div>
                    <div class="filter">
                        <label for="problemFilterPie">Tipo de Problema:</label>
                        <select id="problemFilterPie">
                            <option value="all">Todos</option>
                            <option value="Acesso Lento"></option>
                            <option value="Acréscimo de canais"></option>
                        
                        </select>
                    </div>
                    <div class="filter">
                        <label for="dateFilterPie">Data:</label>
                        <input type="date" id="dateFilterPie">
                    </div>
                </div>
                <canvas id="pieChart" style="max-width: 300px; max-height: 300px;"></canvas>
                <button onclick="renderGraphs()">Aplicar Filtros</button>             </div>

            <div class="chart-container" style="flex: 1; padding: 10px;">
                <h3>Problemas</h3>
                <div class="filters" style="margin-bottom: 10px;">
                    <div class="filter">
                        <label for="customerFilterBar">Clientes:</label>
                        <select id="customerFilterBar">
                            <option value="all">Todos</option>
                            <option value="476"></option>
                            <option value="490"></option>
                        </select>
                    </div>
                    <div class="filter">
                        <label for="problemFilterBar">Tipo de Problema:</label>
                        <select id="problemFilterBar">
                            <option value="all">Todos</option>
                            <option value="Acesso Lento"></option>
                            <option value="Acréscimo de canais"></option>
                            >
                        </select>
                    </div>
                    <div class="filter">

...
<div class="filter">
    <label for="dateFilterBar">Intervalo de Datas:</label>
    <input type="text" id="dateFilterBar" placeholder="Selecione o intervalo de datas">
</div>
                </div>
                <canvas id="barChart" style="max-width: 300px; max-height: 300px;"></canvas>
                <button onclick="renderGraphs()">Aplicar Filtros</button> <!-- Add this button here -->
            </div>
        </div>
        <button onclick="downloadGraphsAsWord()">Download gráficos em Word</button>
    </div>
</div>

<script>

function renderGraphs() {
    const customerFilterPie = document.getElementById('customerFilterPie').value;
    const customerFilterBar = document.getElementById('customerFilterBar').value;
    const problemFilterPie = document.getElementById('problemFilterPie').value;
    const problemFilterBar = document.getElementById('problemFilterBar').value;
    const dateFilterPie = document.getElementById('dateFilterPie').value;
    const dateFilterBar = document.getElementById('dateFilterBar').value;

    console.log('Filters:', {
        customerFilterPie,
        customerFilterBar,
        problemFilterPie,
        problemFilterBar,
        dateFilterPie,
        dateFilterBar
    });

    let filteredPieData = database;
    let filteredBarData = database;

    if (customerFilterPie !== 'all') {
        filteredPieData = filteredPieData.filter(ticket => ticket.cliente === customerFilterPie);
    }
    if (problemFilterPie !== 'all') {
        filteredPieData = filteredPieData.filter(ticket => ticket.problema === problemFilterPie);
    }
    if (dateFilterPie) {
        const selectedDate = new Date(dateFilterPie);
        filteredPieData = filteredPieData.filter(ticket => {
            const ticketDate = new Date(ticket.inicio);
            return ticketDate.toDateString() === selectedDate.toDateString();
        });
    }

    console.log('Filtered Pie Data:', filteredPieData);

    const pieDataValues = [0, 0];
    filteredPieData.forEach(ticket => {
        if (ticket.status_prazo === 'No Prazo') {
            pieDataValues[0]++;
        } else if (ticket.status_prazo === 'Fora do Prazo') {
            pieDataValues[1]++;
        }
    });

    const pieData = {
        labels: ['Dentro do Prazo', 'Fora do Prazo'],
        datasets: [{
            data: pieDataValues,
            backgroundColor: ['#36A2EB', '#FF6384'],
            hoverBackgroundColor: ['#36A2EB', '#FF6384']
        }]
    };

    if (customerFilterBar !== 'all') {
        filteredBarData = filteredBarData.filter(ticket => ticket.cliente === customerFilterBar);
    }
    if (problemFilterBar !== 'all') {
        filteredBarData = filteredBarData.filter(ticket => ticket.problema === problemFilterBar);
    }
    if (dateFilterBar) {
        const selectedDate = new Date(dateFilterBar);
        filteredBarData = filteredBarData.filter(ticket => {
            const ticketDate = new Date(ticket.inicio);
            return ticketDate.toDateString() === selectedDate.toDateString();
        });
    }

    console.log('Filtered Bar Data:', filteredBarData);

    const barDataValues = {};
    filteredBarData.forEach(ticket => {
        const problem = ticket.problema;
        if (!barDataValues[problem]) {
            barDataValues[problem] = 0;
        }
        barDataValues[problem]++;
    });

    const barData = {
        labels: Object.keys(barDataValues),
        datasets: [{
            label: 'Chamados',
            data: Object.values(barDataValues),
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
        }]
    };

    const pieOptions = {
        responsive: true,
        maintainAspectRatio: false,
    };

    const barOptions = {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    };

    const pieCtx = document.getElementById('pieChart').getContext('2d');
    new Chart(pieCtx, {
        type: 'pie',
        data: pieData,
        options: pieOptions
    });

    const barCtx = document.getElementById('barChart').getContext('2d');
    new Chart(barCtx, {
        type: 'bar',
        data: barData,
        options: barOptions
    });
}

function showGraphs() {
    const graphsView = document.getElementById('graphsView');
    graphsView.style.display = graphsView.style.display === 'none' ? 'block' : 'none';
    if (graphsView.style.display === 'block') {
        renderGraphs();

        flatpickr("#dateFilterPie", {
            mode: "range",
            dateFormat: "d/m/Y",
            locale: "pt",
            onChange: function(selectedDates, dateStr, instance) {
                console.log('Datas selecionadas para Pie:', dateStr);
            }
        });

        flatpickr("#dateFilterBar", {
            mode: "range",
            dateFormat: "d/m/Y",
            locale: "pt",
            onChange: function(selectedDates, dateStr, instance) {
                console.log('Datas selecionadas para Bar:', dateStr);
            }
        });
    }
}


function downloadGraphsAsWord() {
    const pieChart = document.getElementById('pieChart').toDataURL('image/png');
    const barChart = document.getElementById('barChart').toDataURL('image/png');

    const docContent = `
    <html>
    <head><meta charset="utf-8"></head>
    <body>
    <h2>Prazos</h2>
    <img src="${pieChart}" alt="Gráfico de Pizza">
    <h2>Problemas</h2>
    <img src="${barChart}" alt="Gráfico de Barras">
    </body>
    </html>
    `;

    const blob = new Blob(['\ufeff', docContent], {
        type: 'application/msword'
    });

    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'graficos.doc';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

    document.addEventListener('DOMContentLoaded', () => {
    flatpickr("#filterDateRange", {
        mode: "range",
        dateFormat: "d/m/Y",
        locale: "pt",
        onChange: function(selectedDates, dateStr, instance) {
            console.log('Datas selecionadas:', dateStr);
        }
    });
});

    function downloadExcel() {
        let table = document.getElementById('databaseTable');
        let wb = XLSX.utils.table_to_book(table, {sheet: "Sheet JS"});
        XLSX.writeFile(wb, 'Chamados.xlsx');
    }


        function showDatabase() {
            const databaseView = document.getElementById('databaseView');
            databaseView.style.display = databaseView.style.display === 'none' ? 'block' : 'none';
            
            if (databaseView.style.display === 'block') {
                updateDatabaseTable();
            }
        }

function clearDatabase() {
    if (confirm('Tem certeza que deseja limpar o banco de dados?')) {
        database = [];
        localStorage.setItem('ticketDatabase', JSON.stringify(database));
        updateDatabaseTable();
    }
}

function updateDatabaseTable(filters = {}) {
    const tbody = document.getElementById('databaseTableBody');
    tbody.innerHTML = '';

    let filteredData = [...database];

    if (filters.problema) {
        filteredData = filteredData.filter(t => 
            t.problema && t.problema.toLowerCase().includes(filters.problema.toLowerCase())
        );
    }
    if (filters.operador) {
        filteredData = filteredData.filter(t => 
            t.operador && t.operador.toLowerCase().includes(filters.operador.toLowerCase())
        );
    }
    if (filters.cliente) {
        filteredData = filteredData.filter(t => 
            t.cliente && t.cliente.toLowerCase().includes(filters.cliente.toLowerCase())
        );
    }
    if (filters.executor) {
        filteredData = filteredData.filter(t => 
            t.executor && t.executor.toLowerCase().includes(filters.executor.toLowerCase())
        );
    }
    if (filters.status) {
        filteredData = filteredData.filter(t => 
            t.status_prazo && t.status_prazo.toLowerCase().includes(filters.status.toLowerCase())
        );
    }

    // Aplica filtro de data com novo tratamento
    if (filters.startDate && filters.endDate) {
        filteredData = filteredData.filter(ticket => {
            if (!ticket.inicio) return false;
            
            const ticketDate = parseDateTimeStr(ticket.inicio);
            if (!ticketDate) return false;

            // Compara apenas as datas, ignorando o horário
            return ticketDate >= filters.startDate && ticketDate <= filters.endDate;
        });
    }

    filteredData.forEach(ticket => {
        const row = tbody.insertRow();
        const cells = [
            ticket.tempo_previsto || '',
            ticket.cliente || '',
            ticket.problema || '',
            ticket.operador || '',
            ticket.executor || '',
            ticket.inicio || '',
            ticket.arquivado_por || '',
            ticket.fim || '',
            ticket.tempo_decorrido || '',
            ticket.status_prazo || ''
        ];

        cells.forEach(value => {
            const cell = row.insertCell();
            cell.textContent = value;
        });

        // Adiciona classes de cor
        if (ticket.status_prazo === 'No Prazo') {
            row.classList.add('green');
        } else if (ticket.status_prazo === 'Fora do Prazo') {
            row.classList.add('red');
        }
    });
}


    const users = [
        ["Jefferson", "123123"],
        ["Castelo", "123123"],
        ["Gabriel", "123123"],
        ["Kaline", "123123"],
        ["Virgilio", "123123"],
        ["James", "123123"],
        ["Marcelo", "123123"]
    ];

    const operadores = ["", "Castelo", "Marcelo", "kaline", "Gabriel", "Jefferson"];
    const executores = ["", "Airton", "Damião", "Daniel", "Alison"];
    const problemas = ["","Adição de equipamento","Ajuste no IPV6","Ativação de Link","Ativação de Telefonia","Cliente entrou em contato pedindo uma informação tecnica","Falha elétrica no cliente”,“Falha elétrica no POP da Inovanet","Falha no equipamento da Inovanet","Falha no fornecimento de internet pela ALGAR","Falha no fornecimento de internet pela BR DIGITAL","Falha no link de transporte","Help Desk Presencial","Help Desk Remoto","Help Desk Telefonia","implantar cabo de internet","Mudança de endereço","Mudança de Equipamentos","Mudança de Local do Aparelho","Operadora de telefonia com falha de rotas","Orçamento","Outros","Portabilidade da linha","Problema na Hybrid","Problemas com páginas","Problemas no VOIP","Recolher equipamento","Rompimento do Backbone em Natal","Rompimento do drop do cliente em Ceará-Mirim","Rompimento do drop do cliente em Mossoró","Rompimento do drop do cliente em Natal","Rompimento do drop do cliente em Parnamirim","Rompimento no drop em STO","Rompimento no transporte da Intelnet","Rompimento no transporte para Ceará-Mirim","Rompimento no transporte para São José de Mipibu","Sem Acesso","Sem ping","Solicitação BGP","Solicitação de linha nova","Troca de CEO","Troca de conector tipo click","Troca de conector tipo RJ45","Troca de CTO","Troca de DROP","Troca de fonte com defeito","Troca de splitter",];
    const ncOpcoes = ["","1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31", "32", "33", "34", "35", "36", "37", "38", "39", "40", "41", "42", "43", "44", "45", "46", "47", "48", "49", "50", "51", "52", "53", "54", "55", "56", "57", "58", "59", "60", "61", "62", "63", "64", "65", "66", "67", "68", "69", "70", "71", "72", "73", "74", "75", "76", "77", "78", "79", "80", "81", "82", "83", "84", "85", "86", "87", "88", "89", "90", "91", "92", "93", "94", "95", "96", "97", "98", "99", "100", "101", "102", "103", "104", "105", "106", "107", "108", "109", "110", "111", "112", "113", "114", "115", "116", "117", "118", "119", "120", "121", "122", "123", "124", "125", "126", "127", "128", "129", "130", "131", "132", "133", "134", "135", "136", "137", "138", "139", "140", "141", "142", "143", "144", "145", "146", "147", "148", "149", "150", "151", "152", "153", "154", "155", "156", "157", "158", "159", "160", "161", "162", "163", "164", "165", "166", "167", "168", "169", "170", "171", "172", "173", "174", "175", "176", "177", "178", "179", "180", "181", "182", "183", "184", "185", "186", "187", "188", "189", "190", "191", "192", "193", "194", "195", "196", "197", "198", "199", "200", "201", "202", "203", "204", "205", "206", "207", "208", "209", "210", "211", "212", "213", "214", "215", "216", "217", "218", "219", "220", "221", "222", "223", "224", "225", "226", "227", "228", "229", "230", "231", "232", "233", "234", "235", "236", "237", "238", "239", "240", "241", "242", "243", "244", "245", "246", "247", "248", "249", "250", "251", "252", "253", "254", "255", "256", "257", "258", "259", "260", "261", "262", "263", "264", "265", "266", "267", "268", "269", "270", "271", "272", "273", "274", "275", "276", "277", "278", "279", "280", "281", "282", "283", "284", "285", "286", "287", "288", "289", "290", "291", "292", "293", "294", "295", "296", "297", "298", "299", "300", "301", "302", "303", "304", "305", "306", "307", "308", "309", "310", "311", "312", "313", "314", "315", "316", "317", "318", "319", "320", "321", "322", "323", "324", "325", "326", "327", "328", "329", "330", "331", "332", "333", "334", "335", "336", "337", "338", "339", "340", "341", "342", "343", "344", "345", "346", "347", "348", "349", "350", "351", "352", "353", "354", "355", "356", "357", "358", "359", "360", "361", "362", "363", "364", "365", "366", "367", "368", "369", "370", "371", "372", "373", "374", "375", "376", "377", "378", "379", "380", "381", "382", "383", "384", "385", "386", "387", "388", "389", "390", "391", "392", "393", "394", "395", "396", "397", "398", "399", "400", "401", "402", "403", "404", "405", "406", "407", "408", "409", "410", "411", "412", "413", "414", "415", "416", "417", "418", "419", "420", "421", "422", "423", "424", "425", "426", "427", "428", "429", "430", "431", "432", "433", "434", "435", "436", "437", "438", "439", "440", "441", "442", "443", "444", "445", "446", "447", "448", "449", "450", "451", "452", "453", "454", "455", "456", "457", "458", "459", "460", "461", "462", "463", "464", "465", "466", "467", "468", "469", "470", "471", "472", "473", "474", "475", "476", "477", "478", "479", "480", "481", "482", "483", "484", "485", "486", "487", "488", "489", "490", "491", "492", "493", "494", "495", "496", "497", "498", "499", "500", "501", "502", "503", "504", "505", "506", "507", "508", "509", "510", "511", "512", "513", "514", "515", "516", "517", "518", "519", "520", "521", "522", "523", "524", "525", "526", "527", "528", "529", "530", "531", "532", "533", "534", "535", "536", "537", "538", "539", "540", "541", "542", "543", "544", "545", "546", "547", "548", "549", "550", "551", "552", "553", "554", "555", "556", "557", "558", "559", "560", "561", "562", "563", "564", "565", "566", "567", "568", "569", "570", "571", "572", "573", "574", "575", "576", "577", "578", "579", "580", "581", "582", "583", "584", "585", "586", "587", "588", "589", "590", "591", "592", "593", "594", "595", "596", "597", "598", "599", "600", "601", "602", "603", "604", "605", "606", "607", "608", "609", "610", "611", "612", "613", "614", "615", "616", "617", "618", "619", "620", "621", "622", "623", "624", "625", "626", "627", "628", "629", "630", "631", "632", "633", "634", "635", "636", "637", "638", "639", "640", "641", "642", "643", "644", "645", "646", "647", "648", "649", "650", "651", "652", "653", "654", "655", "656", "657", "658", "659", "660", "661", "662", "663", "664", "665", "667", "668", "669", "670", "671", "672", "673", "674", "675", "676", "677", "678", "679", "680", "681", "682", "683", "684", "685", "686", "687", "688", "689", "690", "691", "692", "693", "694", "695", "696", "697", "698", "699", "700", "701", "702", "703", "704", "705", "706", "707", "708", "709", "710", "711", "712", "713", "714", "715", "716", "717", "718", "719", "720", "721", "722", "723", "724", "725", "726", "727", "728", "729", "730", "731", "732", "733", "734", "735", "736", "737", "738", "739", "740", "741", "742", "743", "744", "745", "746", "747", "748", "749", "750", "751", "752", "753", "754", "755", "756", "757", "758", "759", "760", "761", "762", "763", "764", "765", "766", "767", "768", "769", "770", "771", "772", "773", "774", "775", "776", "777", "778", "779", "780", "781", "782", "783", "784", "785", "786", "787", "788", "789", "790", "791", "792", "793", "794", "795", "796", "797", "798", "799", "800", "801", "802", "803", "804", "805", "806", "807", "808", "809", "810", "811", "812", "813", "814", "815", "816", "817", "818", "819", "820", "821", "822", "823", "824", "825", "826", "827", "828", "829", "830", "831", "832", "833", "834", "835", "836", "837", "838", "839", "840", "841", "842", "843", "844", "845", "846", "847", "848", "849", "850", "851", "852", "853", "854", "855", "856", "857", "858", "859", "860", "861", "862", "863", "864", "865", "866", "867", "868", "869", "870", "871", "872", "873", "874", "875", "876", "877", "878", "879", "880", "881", "882", "883", "884", "885", "886", "887", "888", "889", "890", "891", "892", "893", "894", "895", "896", "897", "898", "899", "900", "901", "902", "903", "904", "905", "906", "907", "908", "909", "910", "911", "912", "913", "914", "915", "916", "917", "918", "919", "920", "921", "922", "923", "924", "925", "926", "927", "928", "929", "930", "931", "932", "933", "934", "935", "936", "937", "938", "939", "940", "941", "942", "943", "944", "945", "946", "947", "948", "949", "950", "951", "952", "953", "954", "955", "956", "957", "958", "959", "960", "961", "962", "963", "964", "965", "966", "967", "968", "969", "970", "971", "972", "973", "974", "975", "976", "977", "978", "979", "980", "981", "982", "983", "984", "985", "986", "987", "988", "989", "990", "991", "992", "993", "994", "995", "996", "997", "998", "999", "1000"

]
    let database = JSON.parse(localStorage.getItem('ticketDatabase')) || [];
    let timers = new Map();
    let accumulatedTimes = new Map();

function login() {
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    
    const user = users.find(u => u[0] === username && u[1] === password);
    
    if (user) {
        localStorage.setItem('isLoggedIn', 'true');
        localStorage.setItem('username', username);
        
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('mainContainer').style.display = 'block';
    } else {
        document.getElementById('loginError').textContent = 'Usuário ou senha incorretos';
    }
}


function checkLoginState() {
    const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
    
    if (isLoggedIn) {
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('mainContainer').style.display = 'block';
    } else {
        document.getElementById('loginContainer').style.display = 'block';
        document.getElementById('mainContainer').style.display = 'none';
    }
}

function logout() {
    localStorage.removeItem('isLoggedIn');
    localStorage.removeItem('username');
    document.getElementById('loginContainer').style.display = 'block';
    document.getElementById('mainContainer').style.display = 'none';
}

document.addEventListener('DOMContentLoaded', () => {
    checkLoginState();
    flatpickr("#filterDateRange", {
        mode: "range",
        dateFormat: "d/m/Y",
        locale: "pt",
        onChange: function(selectedDates, dateStr, instance) {
            console.log('Datas selecionadas:', dateStr);
        }
    });
});


function saveTicketsState() {
    const ticketList = document.getElementById('ticketList');
    const tickets = [];
    
    ticketList.querySelectorAll('.ticket-row').forEach(ticketDiv => {
        const ticket = {
            tempo_previsto: ticketDiv.querySelector('input[type="text"]').value,
            cliente: ticketDiv.querySelector('select[id="CLIENTE"]').value,
            problema: ticketDiv.querySelector('select[id="PROBLEMA"]').value,
            operador: ticketDiv.querySelector('select[id="OPERADOR"]').value,
            executor: ticketDiv.querySelector('select[id="EXECUTOR"]').value,
            hora_inicio: ticketDiv.querySelector('input[id="hora_inicio"]').value,
            data_abertura: ticketDiv.querySelector('input[id="data_abertura"]').value,
            hora_fim: ticketDiv.querySelector('input[id="hora_fim"]').value,
            timerState: ticketDiv.getAttribute('data-timer-state'),
            timerType: ticketDiv.getAttribute('data-timer-type'),
            accumulatedTime: ticketDiv.getAttribute('data-accumulated-time'),
            startTime: ticketDiv.getAttribute('data-start-time')
        };
        tickets.push(ticket);
    });
    
    localStorage.setItem('openTickets', JSON.stringify(tickets));
}

function loadTicketsState() {
    const tickets = JSON.parse(localStorage.getItem('openTickets')) || [];
    tickets.forEach(ticket => {
        addNewTicket(ticket);

        if (ticket.timerState === 'running') {
            const ticketDiv = document.querySelector(`#ticketList .ticket-row:last-child`);
            if (ticketDiv) {
                const startTime = parseInt(ticket.startTime);
                const accumulatedTime = parseInt(ticket.accumulatedTime) || 0;
                const elapsedTime = (Date.now() - startTime) / 1000;

                let timeLeft;
                if (ticket.timerType === 'T') {
                    timeLeft = timeToSeconds(ticket.tempo_previsto) - elapsedTime - accumulatedTime;
                } else {
                    timeLeft = accumulatedTime + elapsedTime;
                }

                startTimer(ticketDiv, timeLeft);
            }
        }
    });
}

document.addEventListener('DOMContentLoaded', () => {
    checkLoginState();
    loadTicketsState(); 

    flatpickr("#filterDateRange", {
        mode: "range",
        dateFormat: "d/m/Y",
        locale: "pt",
        onChange: function(selectedDates, dateStr, instance) {
            console.log('Datas selecionadas:', dateStr);
        }
    });
});

    function createSelect(options, id) {
        const select = document.createElement('select');
        select.id = id;
        options.forEach(option => {
            const opt = document.createElement('option');
            opt.value = option;
            opt.textContent = option;
            select.appendChild(opt);
        });
        return select;
    }
function addComment(ticketDiv) {
    const comment = prompt('Digite seu comentário:');
    if (comment) {
        const ticketId = ticketDiv.dataset.ticketId;
        comments.push({ ticketId, comment });
        alert('Comentário adicionado com sucesso!');
    }
}

function downloadCommentsAsExcel() {
    const ws = XLSX.utils.json_to_sheet(comments);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Comments");
    XLSX.writeFile(wb, 'Comments.xlsx');
}

function archiveTicket(ticketDiv) {
    validatePasswordAndExecute((username) => {
        const tempoPrevisto = ticketDiv.querySelector('input[type="text"]').value;
        const horaInicio = ticketDiv.querySelector('input[id="hora_inicio"]').value;
        const dataAbertura = ticketDiv.querySelector('input[id="data_abertura"]').value;
        const horaFim = new Date().toLocaleTimeString();
        const dataEncerramento = new Date().toLocaleDateString();

        const dataHoraAbertura = `${dataAbertura} ${horaInicio}`;
        
        // Correctly calculate the accumulated execution time
        const startTime = parseDateTimeStr(dataHoraAbertura).getTime(); // Convert start time to timestamp
        const endTime = new Date(`${dataEncerramento} ${horaFim}`).getTime(); // Convert end time to timestamp
        const accumulatedTime = endTime - startTime; // Calculate total time in milliseconds
        const tempoDecorrido = calculateTotalTimeFromMilliseconds(accumulatedTime); // Format as H:M:S

        const tempoPrevistoSeconds = timeToSeconds(tempoPrevisto);
        const tempoDecorridoSeconds = timeToSeconds(tempoDecorrido);

        let statusPrazo;
        const timerType = ticketDiv.getAttribute('data-timer-type');
        if (timerType === 'T' && tempoDecorridoSeconds <= tempoPrevistoSeconds) {
            statusPrazo = 'No Prazo';
        } else {
            statusPrazo = 'Fora do Prazo';
        }

        const ticket = {
            tempo_previsto: tempoPrevisto,
            cliente: ticketDiv.querySelector('select[id="CLIENTE"]').value,
            problema: ticketDiv.querySelector('select[id="PROBLEMA"]').value,
            operador: ticketDiv.querySelector('select[id="OPERADOR"]').value,
            executor: ticketDiv.querySelector('select[id="EXECUTOR"]').value,
            data_hora_abertura: dataHoraAbertura,
            hora_fim: `${dataEncerramento} ${horaFim}`,
            arquivado_por: username,
            inicio: dataHoraAbertura,
            fim: `${dataEncerramento} ${horaFim}`,
            tempo_decorrido: tempoDecorrido, // Correctly calculated execution time
            status_prazo: statusPrazo
        };

        if (!ticket.cliente || !ticket.problema || !ticket.operador || !ticket.executor) {
            alert('Por favor, preencha todos os campos obrigatórios antes de arquivar.');
            return;
        }

        database.push(ticket);
        localStorage.setItem('ticketDatabase', JSON.stringify(database));

        if (timers.has(ticketDiv)) {
            clearInterval(timers.get(ticketDiv));
            timers.delete(ticketDiv);
        }

        ticketDiv.remove();

        const databaseView = document.getElementById('databaseView');
        if (databaseView.style.display === 'block') {
            updateDatabaseTable();
        }

        alert(`Chamado arquivado com sucesso!\n
            Data de abertura: ${dataAbertura} Hora de abertura: ${horaInicio}\n
            Data de encerramento: ${dataEncerramento} Hora de encerramento: ${horaFim}\n
            Tempo de execução: ${tempoDecorrido}`);
    });
}

const tempoDecorrido = calculateTotalTimeFromMilliseconds(accumulatedTime); // Format as H:M:S

function calculateTotalTimeFromMilliseconds(ms) {
    const hours = String(Math.floor(accumulatedTime / 3600000)).padStart(2, '0');
    const minutes = String(Math.floor((accumulatedTime % 3600000) / 60000)).padStart(2, '0');
    const seconds = String(Math.floor((accumulatedTime % 60000) / 1000)).padStart(2, '0');
    const tempoDecorrido = `${hours}:${minutes}:${seconds}`; // Format as 00:00:00

    return `${hours}:${minutes}:${seconds}`;
}

function addNewTicket(ticket = {}) {
    const ticketList = document.getElementById('ticketList');
    if (!ticketList) {
        console.error('Ticket list container not found');
        return;
    }

    const ticketDiv = document.createElement('div');
    ticketDiv.className = 'ticket-row';
    ticketDiv.dataset.ticketId = Date.now(); // Unique identifier for the ticket

    const fields = {
        tempo_previsto: document.createElement('input'),
        CLIENTE: createSelect(ncOpcoes, 'CLIENTE'),
        PROBLEMA: createSelect(problemas, 'PROBLEMA'),
        OPERADOR: createSelect(operadores, 'OPERADOR'),
        EXECUTOR: createSelect(executores, 'EXECUTOR'),
        hora_inicio: document.createElement('input'),
        data_abertura: document.createElement('input'),
        hora_fim: document.createElement('input')
    };

    fields.tempo_previsto.type = 'text';
    fields.tempo_previsto.className = 'input-time';
    fields.tempo_previsto.placeholder = 'H:M:S';
    fields.tempo_previsto.value = ticket.tempo_previsto || '';

    fields.tempo_previsto.addEventListener('input', function (e) {
        e.target.value = e.target.value.replace(/[^0-9:]/g, ''); // Allow only numbers and colons
    });

    fields.tempo_previsto.addEventListener('blur', function (e) {
        if (e.target.value) {
            let parts = e.target.value.split(':');
            parts = parts.map(part => part.padStart(2, '0'));
            while (parts.length < 3) parts.push('00'); // Ensure HH:MM:SS format
            e.target.value = parts.slice(0, 3).join(':');
        }
    });

    fields.hora_inicio.readOnly = true;
    fields.hora_inicio.id = 'hora_inicio';
    fields.hora_inicio.value = ticket.hora_inicio || '';

    fields.data_abertura.readOnly = true;
    fields.data_abertura.id = 'data_abertura';
    fields.data_abertura.value = ticket.data_abertura || '';

    fields.hora_fim.readOnly = true;
    fields.hora_fim.id = 'hora_fim';
    fields.hora_fim.value = ticket.hora_fim || '';

    fields.CLIENTE.value = ticket.cliente || '';
    fields.PROBLEMA.value = ticket.problema || '';
    fields.OPERADOR.value = ticket.operador || '';
    fields.EXECUTOR.value = ticket.executor || '';

    Object.entries(fields).forEach(([key, field]) => {
        const label = document.createElement('label');
        label.textContent = {
            tempo_previsto: 'TEMPO PREVISTO:',
            hora_inicio: 'HORA DE INÍCIO:',
            data_abertura: 'DATA DE ABERTURA:',
            hora_fim: 'HORA FINAL:'
        }[key] || key.toUpperCase() + ':';
        ticketDiv.appendChild(label);
        ticketDiv.appendChild(field);
    });

    const timerDisplay = document.createElement('div');
    timerDisplay.className = 'timer';
    const timerType = ticket.timerType || 'T';
    const accumulatedTime = parseInt(ticket.accumulatedTime, 10) || 0;
    updateTimerDisplay(timerDisplay, accumulatedTime, timerType);
    ticketDiv.setAttribute('data-timer-type', timerType);
    ticketDiv.setAttribute('data-timer-state', ticket.timerState || 'stopped');
    ticketDiv.setAttribute('data-accumulated-time', accumulatedTime.toString());
    ticketDiv.setAttribute('data-start-time', ticket.startTime || '');

    const buttonContainer = document.createElement('div');
    const buttonActions = [
        { icon: 'fas fa-play', handler: 'iniciar' },
        { icon: 'fas fa-archive', handler: 'arquivar' },
        { icon: 'fas fa-comment', handler: 'comentar' }
    ];

    buttonActions.forEach(({ icon, handler }) => {
        const button = document.createElement('button');
        button.innerHTML = `<i class="${icon}"></i>`;
        button.onclick = () => handleTicketAction(handler, ticketDiv);
        buttonContainer.appendChild(button);
    });

    ticketDiv.appendChild(timerDisplay);
    ticketDiv.appendChild(buttonContainer);
    ticketList.appendChild(ticketDiv);

    // If the ticket's timer was running, restore it
    if (ticket.timerState === 'running') {
        startTimer(ticketDiv, accumulatedTime);
    }

    saveTicketsState(); // Save the updated state of tickets
}


// Ensure the function parseDateTimeStr is correctly implemented
function parseDateTimeStr(dateTimeStr) {
    const [datePart, timePart] = dateTimeStr.split(' ');
    const [day, month, year] = datePart.split('/').map(Number);
    const [hours, minutes, seconds] = timePart.split(':').map(Number);
    return new Date(year, month - 1, day, hours, minutes, seconds || 0);
}


function calculateTotalTime(startTime, endTime) {
    const start = new Date(`1970-01-01T${startTime}Z`);
    const end = new Date(`1970-01-01T${endTime}Z`);
    const diff = Math.floor((end - start) / 1000);

    const hours = Math.floor(diff / 3600);
    const minutes = Math.floor((diff % 3600) / 60);
    const seconds = diff % 60;

    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}

function timeToSeconds(timeStr) {
    if (!timeStr) return 0;
    const parts = timeStr.split(':').map(Number);
    while (parts.length < 3) parts.unshift(0);
    return parts[0] * 3600 + parts[1] * 60 + parts[2];
}


// Função auxiliar para validar o formato do tempo
function isValidTimeFormat(timeStr) {
    return /^\d{1,2}:\d{1,2}:\d{1,2}$/.test(timeStr);
}

// Função startTimer corrigida
function startTimer(ticketDiv, resumeFrom = null) {
    const timerDisplay = ticketDiv.querySelector('.timer');
    const tsInput = ticketDiv.querySelector('.input-time');
    const ts = timeToSeconds(tsInput.value || '0:0:0');
    let timeLeft = resumeFrom !== null ? resumeFrom : ts;
    let timerType = ticketDiv.getAttribute('data-timer-type');

    if (timers.has(ticketDiv)) {
        clearInterval(timers.get(ticketDiv));
    }

    const startTime = parseInt(ticketDiv.getAttribute('data-start-time')) || Date.now();
    const accumulatedTime = parseInt(ticketDiv.getAttribute('data-accumulated-time')) || 0;

    ticketDiv.setAttribute('data-start-time', startTime);

    const timer = setInterval(() => {
        const elapsedTime = (Date.now() - startTime) / 1000;
        let totalTime;

        if (timerType === 'T') {
            totalTime = ts - elapsedTime - accumulatedTime;
            if (totalTime <= 0) {
                timerType = 'A';
                ticketDiv.setAttribute('data-timer-type', 'A');
                totalTime = -totalTime;
                ticketDiv.classList.add('red');
            }
        } else {
            totalTime = elapsedTime + accumulatedTime;
        }

        updateTimerDisplay(timerDisplay, totalTime, timerType);
        updateTicketColor(ticketDiv, totalTime / ts);

        ticketDiv.setAttribute('data-accumulated-time', accumulatedTime + elapsedTime);
        saveTicketsState(); // Save state periodically
    }, 1000);

    timers.set(ticketDiv, timer);
}

function pauseTimer(ticketDiv) {
    if (timers.has(ticketDiv)) {
        clearInterval(timers.get(ticketDiv));
        timers.delete(ticketDiv);

        const startTime = parseInt(ticketDiv.getAttribute('data-start-time')) || 0;
        const accumulatedTime = parseInt(ticketDiv.getAttribute('data-accumulated-time')) || 0;
        const elapsedTime = (Date.now() - startTime);
        const newAccumulatedTime = accumulatedTime + elapsedTime;

        ticketDiv.setAttribute('data-accumulated-time', newAccumulatedTime);
        saveTicketsState(); // 
    }
}

function getTimerValue(ticketDiv) {
    const timerDisplay = ticketDiv.querySelector('.timer').textContent;
    const [, timeStr] = timerDisplay.split(': ');
    const [hours, minutes, seconds] = timeStr.split(':').map(Number);
    return hours * 3600 + minutes * 60 + seconds;
}


function updateTimerDisplay(display, time, prefix) {
    const hours = Math.floor(time / 3600);
    const minutes = Math.floor((time % 3600) / 60);
    const seconds = time % 60;
    display.textContent = `${prefix}: ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}
function updateTicketColor(ticketDiv, percentage) {
    ticketDiv.className = 'ticket-row';
    if (percentage > 0.75) {
        ticketDiv.classList.add('green');
    } else if (percentage > 0.5) {
        ticketDiv.classList.add('yellow');
    } else if (percentage > 0.2) {
        ticketDiv.classList.add('orange');
    } else {
        ticketDiv.classList.add('red');
    }
}



        function isValidTimeFormat(timeStr) {
            return /^\d{1,2}:\d{1,2}:\d{1,2}$/.test(timeStr);
        }

        function timeToSeconds(timeStr) {
            const [hours, minutes, seconds] = timeStr.split(':').map(Number);
            return hours * 3600 + minutes * 60 + seconds;
        }

function handleTicketAction(action, ticketDiv) {
    switch(action) {
        case 'iniciar':
            validatePasswordAndExecute(() => {
                if (ticketDiv.getAttribute('data-timer-state') === 'stopped') {
                    const tsInput = ticketDiv.querySelector('.input-time');
                    if (!tsInput || !tsInput.value || !isValidTimeFormat(tsInput.value)) {
                        alert('Por favor, insira um tempo válido no formato H:M:S');
                        return;
                    }
                    const currentTime = new Date().toLocaleTimeString();
                    const currentDate = new Date().toLocaleDateString();
                    const horaInicioInput = ticketDiv.querySelector('input[id="hora_inicio"]');
                    const dataAberturaInput = ticketDiv.querySelector('input[id="data_abertura"]');
                    if (horaInicioInput) {
                        horaInicioInput.value = currentTime;
                    }
                    if (dataAberturaInput) {
                        dataAberturaInput.value = currentDate;
                    }
                    startTimer(ticketDiv);
                    ticketDiv.setAttribute('data-timer-state', 'running');
                    saveTicketsState();
                }
            });
            break;

        case 'arquivar':
            archiveTicket(ticketDiv);
            saveTicketsState();
            break;

        case 'comentar':
            addComment(ticketDiv);
            break;
    }
}

function calculateTotalTimeFromMilliseconds(ms) {
    const totalSeconds = Math.floor(ms / 1000);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;

    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}


        function startTimer(ticketDiv, resumeFrom = null) {
            const timerDisplay = ticketDiv.querySelector('.timer');
            const tsInput = ticketDiv.querySelector('.input-time');
            const ts = timeToSeconds(tsInput.value || '0:0:0');
            let timeLeft = resumeFrom !== null ? resumeFrom : ts;
            let timerType = ticketDiv.getAttribute('data-timer-type');

            if (timers.has(ticketDiv)) {
                clearInterval(timers.get(ticketDiv));
            }

            const startTime = Date.now(); // Capture the start time
            ticketDiv.setAttribute('data-start-time', startTime);

            const timer = setInterval(() => {
                if (timerType === 'T' && timeLeft > 0) {
                    timeLeft--;
                    updateTimerDisplay(timerDisplay, timeLeft, 'T');
                    updateTicketColor(ticketDiv, timeLeft / ts);

                    if (timeLeft === 0) {
                        timerType = 'A';
                        ticketDiv.setAttribute('data-timer-type', 'A');
                        timeLeft = 0;
                        ticketDiv.classList.add('red');
                    }
                } else {
                    timeLeft++;
                    updateTimerDisplay(timerDisplay, timeLeft, 'A');
                    ticketDiv.classList.add('red');
                }
            }, 1000);

            timers.set(ticketDiv, timer);
}



        function validatePasswordAndExecute(callback) {
            const username = prompt('Digite seu nome de usuário:');
            const password = prompt('Digite sua senha:');
            
            const user = users.find(u => u[0] === username && u[1] === password);
        
            if (user) {
                callback(username);
            } else {
                alert('Usuário ou senha incorretos!');
        }
    }


        function calculateTotalTime(startTime, endTime) {
            const start = new Date(`1970-01-01T${startTime}Z`);
            const end = new Date(`1970-01-01T${endTime}Z`);
            const diff = Math.floor((end - start) / 1000);

            const hours = Math.floor(diff / 3600);
            const minutes = Math.floor((diff % 3600) / 60);
            const seconds = diff % 60;

            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}


        function showDatabase() {
            const databaseView = document.getElementById('databaseView');
            databaseView.style.display = databaseView.style.display === 'none' ? 'block' : 'none';
            if (databaseView.style.display ==='block') {
                updateDatabaseTable();
            }
        }


function applyFilters() {
    const filterDateRange = document.getElementById('filterDateRange').value;
    const filterPR = document.getElementById('filterPR').value;
    const filterEX = document.getElementById('filterEX').value;
    const filterStatus = document.getElementById('filterStatus').value;
    const filterCliente = document.getElementById('filterCliente').value;
    const filterOperador = document.getElementById('filterOperador').value; // Add this line

    let startDate = null;
    let endDate = null;

    if (filterDateRange) {
        const dates = filterDateRange.split(' to ');
        if (dates[0]) {
            startDate = parseDateTimeStr(dates[0]);
            if (startDate) {
                startDate.setHours(0, 0, 0, 0);
            }
            
            if (dates[1]) {
                endDate = parseDateTimeStr(dates[1]);
                if (endDate) {
                    endDate.setHours(23, 59, 59, 999);
                }
            } else {
                // Se só uma data foi selecionada, usa ela como início e fim
                endDate = parseDateTimeStr(dates[0]);
                if (endDate) {
                    endDate.setHours(23, 59, 59, 999);
                }
            }
        }
    }

    const filters = {
        problema: filterPR,
        executor: filterEX,
        status: filterStatus,
        cliente: filterCliente,
        operador: filterOperador, // Add this line
        startDate,
        endDate
    };

    updateDatabaseTable(filters);
}

function parseDateTimeStr(dateTimeStr) {
    if (!dateTimeStr) return null;
    
    try {

        if (dateTimeStr.includes(' ')) {
            const [dateStr, timeStr] = dateTimeStr.split(' ');
            const [day, month, year] = dateStr.split('/').map(Number);
            return new Date(year, month - 1, day);
        }
        // Se a string contém apenas data
        const [day, month, year] = dateTimeStr.split('/').map(Number);
        return new Date(year, month - 1, day);
    } catch (e) {
        console.error('Erro ao converter data:', dateTimeStr, e);
        return null;
    }
}



function formatDateTime(date) {
    return date.toLocaleString('pt-BR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
}


function clearDatabase() {
    if (confirm('Tem certeza que deseja limpar o banco de dados?')) {
        database = [];
        localStorage.setItem('ticketDatabase', JSON.stringify(database));
        updateDatabaseTable();
    }
}

    </script>
</body>
</html>
